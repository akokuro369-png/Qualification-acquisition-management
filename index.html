<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2ç´šå»ºç¯‰å£« å­¦ç¿’ã‚¯ã‚¨ã‚¹ãƒˆ</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å­¦ç¿’ã‚¯ã‚¨ã‚¹ãƒˆ">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2921/2921226.png">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4 select-none">

    <header class="max-w-md mx-auto mb-6 pt-2 text-center">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">
            <span>ğŸ—ï¸</span> å­¦ç¿’ã‚¯ã‚¨ã‚¹ãƒˆ
        </h1>
        <p class="text-xs text-gray-400 mt-1">iPad mini Review App</p>
    </header>

    <main id="card-container" class="max-w-md mx-auto space-y-3 pb-20">
        <div class="text-center text-gray-400 py-20 animate-pulse flex flex-col items-center gap-3">
            <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
            <p>èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
    </main>

    <script>
        // â–¼â–¼â–¼ è¨­å®šã‚¨ãƒªã‚¢ï¼šè©¦é¨“æ—¥ãƒªã‚¹ãƒˆ â–¼â–¼â–¼
        const EXAM_LIST = [
            { name: '2ç´šå»ºç¯‰å£« å­¦ç§‘', date: '2026-07-05' },
            { name: '2ç´šå»ºç¯‰å£« è£½å›³', date: '2026-09-13' },
            { name: 'BIMåˆ©ç”¨æŠ€è¡“è€…1ç´š', date: '2026-09-06' },
            // å¿…è¦ã«å¿œã˜ã¦ã“ã“ã«è¿½åŠ ã—ã¦ãã ã•ã„
            // { name: 'BIMåˆ©ç”¨æŠ€è¡“è€…1ç´š', date: '2026-09-06' }, 
        ];
        // â–²â–²â–² è¨­å®šã‚¨ãƒªã‚¢ã“ã“ã¾ã§ â–²â–²â–²

        const API_URL = "https://script.google.com/macros/s/AKfycbz9V4Li167jvFPCbSaCsvSoeENi38KMYQdxJyY9zIuiNyGn8xbdNTAW7s62Spc2v-5X/exec";

        // æ—¥ä»˜æ•´å½¢
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³HTMLç”Ÿæˆé–¢æ•°
        function getCountdownHtml(targetDate) {
            const today = new Date(); today.setHours(0,0,0,0);
            const target = new Date(targetDate); target.setHours(0,0,0,0);
            const diffDays = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays > 0) return `ã‚ã¨ <span class="text-red-600 text-2xl font-bold">${diffDays}</span> æ—¥`;
            if (diffDays === 0) return `<span class="text-red-600 font-bold">ä»Šæ—¥ãŒæœ¬ç•ªï¼</span>`;
            return `<span class="text-gray-400 text-xs">çµ‚äº†</span>`;
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        async function fetchTasks() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                renderCards(data);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('card-container').innerHTML = `
                    <div class="p-6 bg-red-50 text-red-600 rounded-xl text-center border border-red-100">
                        <p class="font-bold mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ ğŸ˜¢</p>
                        <p class="text-sm">é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã™ã‚‹ã‹ã€<br>GASã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚</p>
                    </div>`;
            }
        }

        // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
        function renderCards(data) {
            const container = document.getElementById('card-container');
            container.innerHTML = '';

            // 1. â–¼â–¼â–¼ ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆã“ã“ã«è¿½åŠ ï¼‰ â–¼â–¼â–¼
            const countdownContainer = document.createElement('div');
            countdownContainer.className = 'grid grid-cols-1 gap-3 mb-6';

            EXAM_LIST.forEach(exam => {
                const examDiv = document.createElement('div');
                examDiv.className = 'bg-white border border-red-100 text-gray-700 p-3 rounded-lg shadow-sm flex items-center justify-between px-4';
                examDiv.innerHTML = `
                    <div class="text-left">
                        <p class="text-xs text-gray-500 font-bold">${exam.name}</p>
                        <p class="text-[10px] text-gray-400">${formatDate(exam.date)}</p>
                    </div>
                    <div class="text-base text-right">
                        ${getCountdownHtml(exam.date)}
                    </div>
                `;
                countdownContainer.appendChild(examDiv);
            });
            container.appendChild(countdownContainer);
            // â–²â–²â–² ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã“ã“ã¾ã§ â–²â–²â–²

            // ãƒ‡ãƒ¼ã‚¿ãŒç©ºï¼ˆå®Œäº†ï¼‰ã®å ´åˆ
            if (data.length === 0) {
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®ä¸‹ã«å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
                const completeMsg = document.createElement('div');
                completeMsg.className = "text-center text-gray-400 py-10";
                completeMsg.innerHTML = `
                        <p class="text-4xl mb-2">ğŸ‰</p>
                        <p>ä»Šæ—¥ã®å¾©ç¿’ã¯ã™ã¹ã¦å®Œäº†ã§ã™ï¼</p>
                    `;
                container.appendChild(completeMsg);
                return;
            }

            // 2. ã‚¿ã‚¹ã‚¯ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
            data.forEach(row => {
                const id = row[0];
                const examName = row[1];
                const categoryL = row[2];
                const categoryM = row[3]; // ä¸­é …ç›® (ä¾‹: ç¬¬1ç·¨_ç’°å¢ƒå·¥å­¦) -> ã“ã‚Œã‚’å°ã•ãã™ã‚‹
                const categoryS = row[4]; // å°é …ç›® (ä¾‹: ç¬¬2ç« _æ›æ°—) -> ã“ã‚Œã‚’å¤§ããã™ã‚‹
                const level = row[5];
                const nextDate = row[6];

                // é–€ç•ªã‚³ãƒ¼ãƒ‰
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                const reviewDate = new Date(nextDate);

                if (reviewDate > today) {
                    return; 
                }

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between transition-all hover:shadow-md mb-3';
                
                card.innerHTML = `
                    <div class="flex-1 min-w-0 pr-3">
                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200 whitespace-nowrap">
                                ${examName}
                            </span>
                            <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100 whitespace-nowrap">
                                ${categoryL}
                            </span>
                            <span class="text-[10px] text-red-500 border border-red-200 px-1.5 py-0.5 rounded ml-auto font-mono bg-white">
                                Lv.${level}
                            </span>
                        </div>
                        
                        <p class="text-xs text-gray-500 leading-tight mb-1 truncate">
                            ${categoryM}
                        </p>

                        <h3 class="font-bold text-gray-800 text-lg mb-2 leading-tight">
                            ${categoryS}
                        </h3>
                        <div class="text-xs text-gray-400 flex items-center gap-1.5 border-t border-gray-100 pt-2 mt-1">
                            <svg class="w-3.5 h-3.5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="font-mono pt-0.5">æ¬¡å›: ${formatDate(nextDate)}</span>
                        </div>
                    </div>
                    
                    <button onclick="completeTask('${id}', this)" 
                            class="shrink-0 w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-lg active:scale-90 transition-all hover:bg-blue-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // å®Œäº†ãƒœã‚¿ãƒ³å‡¦ç†
        function completeTask(id, btnElement) {
            const originalContent = btnElement.innerHTML;
            btnElement.innerHTML = `<div class="animate-spin h-5 w-5 border-2 border-white border-t-transparent rounded-full"></div>`;
            btnElement.disabled = true;

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `id=${id}`
            }).then(() => {
                const card = btnElement.closest('div.bg-white');
                card.style.transition = "all 0.5s ease-out";
                card.style.opacity = "0";
                card.style.transform = "translateX(50px)";
                setTimeout(() => {
                    card.remove();
                    // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¨ãƒªã‚¢(children[0])ä»¥å¤–ã«è¦ç´ ãŒãªã‘ã‚Œã°å®Œäº†
                    if(document.getElementById('card-container').children.length === 1) {
                         const completeMsg = document.createElement('div');
                         completeMsg.className = "text-center text-gray-400 py-10 animate-fade-in";
                         completeMsg.innerHTML = `
                            <p class="text-4xl mb-2">ğŸ‰</p>
                            <p>ä»Šæ—¥ã®ãƒãƒ«ãƒé”æˆã§ã™ï¼</p>
                         `;
                         document.getElementById('card-container').appendChild(completeMsg);
                    }
                }, 500);
            }).catch(err => {
                console.error(err);
                alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ï¼šã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ãã ã•ã„');
                btnElement.innerHTML = originalContent;
                btnElement.disabled = false;
            });
        }

        fetchTasks();
    </script>
</body>
</html>