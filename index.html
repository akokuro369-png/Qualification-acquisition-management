<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2ç´šå»ºç¯‰å£« å­¦ç¿’ã‚¯ã‚¨ã‚¹ãƒˆ</title>
<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å­¦ç¿’ã‚¯ã‚¨ã‚¹ãƒˆ">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2921/2921226.png">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen p-4 select-none">

    <header class="max-w-md mx-auto mb-6 pt-2 text-center">
        <h1 class="text-2xl font-bold text-gray-800 flex items-center justify-center gap-2">
            <span>ğŸ—ï¸</span> å­¦ç¿’ã‚¯ã‚¨ã‚¹ãƒˆ
        </h1>
        <p class="text-xs text-gray-400 mt-1">iPad mini Review App</p>
    </header>

    <main id="card-container" class="max-w-md mx-auto space-y-3 pb-20">
        <div class="text-center text-gray-400 py-20 animate-pulse flex flex-col items-center gap-3">
            <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
            <p>èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
        </div>
    </main>

    <script>
        // â–¼â–¼â–¼ ã“ã“ã‚’æ–°ã—ã„URLã«æ›´æ–°ã—ã¾ã—ãŸ â–¼â–¼â–¼
        const API_URL = "https://script.google.com/macros/s/AKfycbz9V4Li167jvFPCbSaCsvSoeENi38KMYQdxJyY9zIuiNyGn8xbdNTAW7s62Spc2v-5X/exec";

        // æ—¥ä»˜ã‚’è¦‹ã‚„ã™ãæ•´å½¢ã™ã‚‹é–¢æ•° (2025-12-31T... -> 2025/12/31)
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ja-JP', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã™ã‚‹
        async function fetchTasks() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                renderCards(data);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('card-container').innerHTML = `
                    <div class="p-6 bg-red-50 text-red-600 rounded-xl text-center border border-red-100">
                        <p class="font-bold mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ ğŸ˜¢</p>
                        <p class="text-sm">GASã®ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šãŒ<br>ã€Œå…¨å“¡ (Anyone)ã€ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>`;
            }
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦è¡¨ç¤º
        function renderCards(data) {
            const container = document.getElementById('card-container');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 py-10">
                        <p class="text-4xl mb-2">ğŸ‰</p>
                        <p>ä»Šæ—¥ã®å¾©ç¿’ã¯ã™ã¹ã¦å®Œäº†ã§ã™ï¼</p>
                    </div>`;
                return;
            }

data.forEach(row => {
                // 1. â–¼â–¼â–¼ å…ˆã«ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ•°ã«å–ã‚Šå‡ºã™ï¼ˆã“ã‚Œã‚’ä¸€ç•ªä¸Šã«ï¼ï¼‰ â–¼â–¼â–¼
                const id = row[0];
                const examName = row[1];     // "2ç´šå»ºç¯‰å£«"
                const categoryL = row[2];    // "å¤§: å»ºç¯‰è¨ˆç”»"
                const title = row[3];        // "ä¸­: ç¬¬1ç·¨..."
                const categoryS = row[4];    // "å°: ç¬¬1ç« ..."
                const level = row[5];        // "level"
                const nextDate = row[6];     // "æ—¥ä»˜" â† ã“ã‚ŒãŒã“ã“ã§å®šç¾©ã•ã‚Œãªã„ã¨æ¬¡ã§ä½¿ãˆãªã„ï¼

                // 2. â–¼â–¼â–¼ é–€ç•ªã‚³ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Šå‡ºã—ãŸå¾Œã«ãƒã‚§ãƒƒã‚¯ï¼‰ â–¼â–¼â–¼
                const today = new Date();
                today.setHours(23, 59, 59, 999); // ä»Šæ—¥ã®å¤œä¸­ã¾ã§OK
                
                // nextDateã‚’æ—¥ä»˜å‹ã«å¤‰æ›
                const reviewDate = new Date(nextDate);

                // ã€Œå¾©ç¿’æ—¥ã€ãŒã€Œä»Šæ—¥ã€ã‚ˆã‚Šæœªæ¥ãªã‚‰ã€ã“ã“ã§å¸°ã£ã¦ã‚‚ã‚‰ã†ï¼ˆreturnï¼‰
                if (reviewDate > today) {
                    return; 
                }

                // 3. â–¼â–¼â–¼ HTMLã®ç”Ÿæˆï¼ˆã“ã“ã‹ã‚‰ä¸‹ã¯å¤‰æ›´ãªã—ï¼‰ â–¼â–¼â–¼
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between transition-all hover:shadow-md mb-3';
                
                card.innerHTML = `
                    <div class="flex-1 min-w-0 pr-3">
                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <span class="text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-0.5 rounded border border-gray-200 whitespace-nowrap">
                                ${examName}
                            </span>
                            <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded border border-blue-100 whitespace-nowrap">
                                ${categoryL}
                            </span>
                            <span class="text-[10px] text-red-500 border border-red-200 px-1.5 py-0.5 rounded ml-auto font-mono bg-white">
                                Lv.${level}
                            </span>
                        </div>
                        
                        <h3 class="font-bold text-gray-800 text-lg leading-tight mb-1 truncate">
                            ${title}
                        </h3>

                        <p class="text-xs text-gray-500 mb-2">
                            ${categoryS}
                        </p>
                        
                        <div class="text-xs text-gray-400 flex items-center gap-1.5 border-t border-gray-100 pt-2 mt-1">
                            <svg class="w-3.5 h-3.5 opacity-60" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            <span class="font-mono pt-0.5">æ¬¡å›: ${formatDate(nextDate)}</span>
                        </div>
                    </div>
                    
                    <button onclick="completeTask('${id}', this)" 
                            class="shrink-0 w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center shadow-lg active:scale-90 transition-all hover:bg-blue-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                        </svg>
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆ
        fetchTasks();
    </script>
</body>
</html>